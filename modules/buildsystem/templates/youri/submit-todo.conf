<% 
escaped_domain = domain.gsub('.','\.')
repository_root = scope.lookupvar('buildsystem::var::repository::bootstrap_root')
sched_home_dir = scope.lookupvar('buildsystem::var::scheduler::homedir')
sched_login = scope.lookupvar('buildsystem::var::scheduler::login')
%>

home: <%= sched_home_dir %>

# repository declaration
repository:
    class: Youri::Repository::Mageia
    options:
        install_root: <%= repository_root %>/distrib
        upload_root: ${home}/uploads/
        upload_state: todo done queue
        queue: todo
        noarch: i586
        svn: svn+ssh://svn.<%= domain %>/svn/packages/cauldron/
        2:
            arch: i586 x86_64
        1:
            arch: i586 x86_64
        infra_1:
            arch: i586 x86_64
        infra_2:
            arch: i586 x86_64
        cauldron:
            arch: i586 x86_64

# targets definition
targets:
    cauldron:
        checks:
            - source
            - deps
            - version
            #- svn
            - tag
            - acl
            - host
            #- section
            - rpmlint
            - recency
            #- history
            - queue_recency
        actions:
            - send
            - rpminfo
            - ulri

    1:
        checks:
            - source
            - version
            #- svn
            - tag
            - acl
            - host
            #- section
            - rpmlint
            - recency
            #- history
            - queue_recency
        actions:
            - send
            - rpminfo
            - ulri

    2:
        checks:
            - source
            - version
            #- svn
            - tag
            - acl
            - host
            #- section
            - rpmlint
            - recency
            #- history
            - queue_recency
        actions:
            - send
            - rpminfo
            - ulri

    infra_1:
        checks:
            - source
            - version
            - tag
            - acl
            - rpmlint
            - recency
            - queue_recency
        actions:
            - send
            - rpminfo
            - ulri

    infra_2:
        checks:
            - source
            - version
            - tag
            - acl
            - rpmlint
            - recency
            - queue_recency
        actions:
            - send
            - rpminfo
            - ulri

# checks definition
checks:
    tag:
        class: Youri::Submit::Check::Tag
        options:
            tags:
                release: 'mga\d+'
              #  packager: '<\S+@<%= escaped_domain %>>$'
                distribution: '^Mageia'
                vendor: '^Mageia.Org$'

    recency:
        class: Youri::Submit::Check::Recency

    queue_recency:
        class: Youri::Submit::Check::Queue_recency

    host:
        class: Youri::Submit::Check::Host
        options:
                   host_file:  /etc/youri/host.conf

    section:
        class: Youri::Submit::Check::Section

    rpmlint:
        class: Youri::Submit::Check::Rpmlint
        options:
            config: /etc/rpmlint/config
            results:
                - buildprereq-use
                - no-description-tag
                - no-summary-tag
                - non-standard-group
                - non-xdg-migrated-menu
                # it breaks dbus
                #- patch-not-applied
                - percent-in-conflicts
                - percent-in-dependency
                - percent-in-obsoletes
                - percent-in-provides
                - summary-ended-with-dot
                - invalid-spec-name
                - noarch-python-in-64bit-path
            cauldron:
                config: /usr/share/rpmlint/config
                path:   /usr/bin/rpmlint
            1:
                config: /usr/share/rpmlint/config.mga2
                path:   /usr/bin/mga2-rpmlint
            2:
                config: /usr/share/rpmlint/config.mga2
                path:   /usr/bin/mga2-rpmlint
            infra_1:
                config: /usr/share/rpmlint/config.mga2
                path:   /usr/bin/mga2-rpmlint
            infra_2:
                config: /usr/share/rpmlint/config.mga2
                path:   /usr/bin/mga2-rpmlint
    svn:
        class: Youri::Submit::Check::SVN

    acl:
        class: Youri::Submit::Check::ACL
        options:
            acl_file: /etc/youri/acl.conf

    history:
        class: Youri::Submit::Check::History

    source:
        class: Youri::Submit::Check::Source

    precedence:
        class: Youri::Submit::Check::Precedence
        options:        
            target: cauldron

    version:
        class: Youri::Submit::Check::Version
        options:
           2:
               authorized_packages: none_package_authorized
               authorized_sections: ^(core|nonfree|tainted)/(updates_testing|backports_testing)$
               authorized_arches: none
               mode: freeze

           1:
               authorized_packages: none_package_authorized
               authorized_sections: ^none$
               authorized_arches: none
               mode: freeze

           cauldron:
#               authorized_sections: ^[a-z]+/updates_testing$
               authorized_sections: ^$
               authorized_packages: ^$
               authorized_arches: none
               authorized_users: ^<%= scope.function_group_members(['mga-release_managers']).join('|') %>$
#               mode: normal
#               mode: version_freeze
               mode: freeze

    deps:
        class: Youri::Submit::Check::Deps

# actions definitions
actions:
    send:
        class: Youri::Submit::Action::Send
        options:
            user: <%= sched_login %>
            keep_svn_release: yes
            uphost: pkgsubmit.<%= domain %>
            root: ${home}/uploads
            ssh_key: ${home}/.ssh/id_rsa

    rpminfo:
        class: Youri::Submit::Action::Rpminfo
        options:
            user:  <%= sched_login %>
            uphost: pkgsubmit.<%= domain %>
            root: ${home}/uploads
            ssh_key: ${home}/.ssh/id_rsa

    ulri:
        class: Youri::Submit::Action::Ulri
        options:
            user:  <%= sched_login %>
            uphost: pkgsubmit.<%= domain %>
            ssh_key: ${home}/.ssh/id_rsa
            logfile: /var/log/<%= sched_login %>/ulri.log

# vim:ft=yaml:et:sw=4
